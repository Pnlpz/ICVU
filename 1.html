
<!DOCTYPE html>

      <html>
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">  
  <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>    
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
  <script src="jquery.csv.min.js"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

  <style type="text/css">
    .hidden {
    display: none;
    visibility: hidden;
  }
  </style>

  <script type="text/javascript">

/***************************/
// REVISAR
// https://jsfiddle.net/PN03/4th0e7e6/8/
// https://stackoverflow.com/questions/40435332/google-charts-sankey-node-text-style
// https://github.com/google/google-visualization-issues/issues/2380
// ALTURA DINAMICA
// https://stackoverflow.com/questions/35408995/google-sankey-chart-adjust-height-automatically
// function
// https://stackoverflow.com/questions/34566777/google-charts-how-to-hide-dynamically-created-series-and-show-only-one-in-legend
// SANKEY D3 https://bl.ocks.org/emeeks/e749224c89f82788cb18
// LEYENDAS https://stackoverflow.com/questions/16980002/how-to-prevent-legend-labels-being-cut-off-in-google-charts
// COLOR https://stackoverflow.com/questions/40435332/google-charts-sankey-node-text-style
// DYNAMICALLY https://stackoverflow.com/questions/21933951/how-to-control-show-hide-the-tooltip-dynamically-in-google-chart-api
// https://stackoverflow.com/questions/42947236/position-icon-after-google-line-chart-title AGREGAR ICONO AL TITULO *****
// https://stackoverflow.com/questions/46401043/adding-a-small-custom-icon-and-popup-to-a-title-of-google-charts ***** IDEM
/***************************/

// =====================================================================================
// =================
// REVISAR ESTO !!!
// =================
// https://developers.google.com/chart/interactive/docs/basic_interactivity
// https://developers.google.com/chart/interactive/docs/animation
// https://developers.google.com/chart/interactive/docs/events
//  https://developers.google.com/chart/interactive/docs/overlays#fullpage2  ****
// http://a32.me/2018/01/change-tooltip-position-on-google-charts/
// =====================================================================================


var theTitle = '';

    google.charts.load('current', {
  packages:['bar', 'table',
  'corechart', 'controls']
}).then(function () {






  // AQUI DEFINO EL ID DEL GRAFICO A EXPORTAR
  var chartContainerRANKING = document.getElementById('chartRanking');
  var chartContainerDETAIL = document.getElementById('chartDetail');

  var button = document.getElementById('button');


  function downloadCanvas(link, canvasId, filename) {
    //console.log("SI");
      link.href = document.getElementById(canvasId).toDataURL();
      link.download = filename;
  }


  $( "#button1" ).click(function() {
      var canvas;
      var domURL;
      var imageNode;
      var imageURL;
      var svgParent;

      // add svg namespace to chart
      domURL = window.URL || window.webkitURL || window;
      svgParent = chartContainerRANKING.getElementsByTagName('svg')[0];
      svgParent.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      imageNode = chartContainerRANKING.cloneNode(true);
      imageURL = domURL.createObjectURL(new Blob([svgParent.outerHTML], {type: 'image/svg+xml'}));
      image = new Image();
      image.onload = function() {
        canvas = document.getElementById('canvas');
        canvas.setAttribute('width', parseFloat(svgParent.getAttribute('width')));
        canvas.setAttribute('height', parseFloat(svgParent.getAttribute('height')));
        canvas.getContext('2d').drawImage(image, 0, 0);
        downloadCanvas(this, 'canvas', 'Ranking.png');
      }
      image.src = imageURL;
    });



  $( "#button2" ).click(function() {
      var canvas;
      var domURL;
      var imageNode;
      var imageURL;
      var svgParent;

      // add svg namespace to chart
      domURL = window.URL || window.webkitURL || window;
      svgParent = chartContainerDETAIL.getElementsByTagName('svg')[0];
      svgParent.setAttribute('xmlns', 'http://www.w3.org/2000/svg');
      imageNode = chartContainerDETAIL.cloneNode(true);
      imageURL = domURL.createObjectURL(new Blob([svgParent.outerHTML], {type: 'image/svg+xml'}));
      image = new Image();
      image.onload = function() {
        canvas = document.getElementById('canvas');
        canvas.setAttribute('width', parseFloat(svgParent.getAttribute('width')));
        canvas.setAttribute('height', parseFloat(svgParent.getAttribute('height')));
        canvas.getContext('2d').drawImage(image, 0, 0);
        downloadCanvas(this, 'canvas', 'Ranking.png');
      }
      image.src = imageURL;
    });
}); // FIN }).then(function () {




var MAXHeight = 2800;

  /// Dashboard =>
  var data;
  var dashboard;
  var barChart;
  var chartTool;
  var dataFull;

  var options = {
    width: 600,
    height: MAXHeight,
    title: 'AAaaa ',
    colors: ['#e0440e', '#e6693e', '#ec8f6e', '#f3b49f', '#f6c7b6'],
    animation:{
      duration: 1000,
      easing: 'out',
    }
  };

/*
  function excludeEmptyRows(dataTable)
  {
    var view = new google.visualization.DataView(dataTable);
    //var rowIndexes = view.getFilteredRows([{column: 1, maxValue: 50}]); //get rows with 0 values
    //getFilteredRows([{column: 3, value: 42}, {column: 2, minValue: 10, maxValue: 50}]) 

    var rowIndexes = view.getFilteredRows([ {column: 1, minValue: 200, maxValue: 500}]) 

    // removeRows(rowIndex, numberOfRows) 
    // getTableRowIndex(viewRowIndex)  // Example: If setRows([3, 1, 4]) was previously called, then getTableRowIndex(2) will return 4.
    // getViewRowIndex(tableRowIndex) // Example: If setRows([3, 1, 4]) was previously called, then getViewRowIndex(4) will return 2.

    // hideRows(min, max) // Hides all rows with indexes that lie between min and max (inclusive) from the current view. This is a convenience syntax for hideRows(rowIndexes) above. For example, hideRows(5, 10) is equivalent to hideRows([5, 6, 7, 8, 9, 10]).
    
    // hideRows(rowIndexes)  // Example: If you have a table with 10 rows, and you call setRows([2,7,1,7,9]), and then hideRows([7,9]), the rows in the view will then be [2,1].



    view.hideRows(rowIndexes); //hide empty rows
    return view.toDataTable();
  } // FIN excludeEmptyRows
*/

    // Load the Visualization API and the controls package.
    //google.charts.load('current', {'packages':['corechart', 'controls']});

    // Set a callback to run when the Google Visualization API is loaded.
    google.charts.setOnLoadCallback(drawDashboard);


    /*
    // plots the data input into the textarea
    function flotTextData() {
      var data1 = $.csv.toArrays($('#textInput').val(), {
        onParseValue: $.csv.hooks.castToScalar
      });
      // this new DataTable object holds all the data
       data = new google.visualization.arrayToDataTable(data1);
        barChart.setOption('title', 'Ranking ICVU 2017 para '+ theTitle );
       dashboard.draw((data), options);
    } // FIN flotTextData
    */


      // Callback that creates and populates a data table,
      // instantiates a dashboard, a range slider and a pie chart,
      // passes in the data and draws it.
      function drawDashboard() {
        /*
        var data1 = $.csv.toArrays($('#textInput').val(), {
          onParseValue: $.csv.hooks.castToScalar
        });
        */
        var data1;

   $.get("datos_icvu2.csv", function(csvString) { // INICIO get
   
        //var arrayData = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
        data1 = $.csv.toArrays(csvString, {onParseValue: $.csv.hooks.castToScalar});
        

        // this new DataTable object holds all the data
        data = new google.visualization.arrayToDataTable(data1);

        var table = new google.visualization.Table(document.getElementById('tabla'));
        table.draw(data, {
          showRowNumber: true, 
          width: '90%', 
          height: '200'}
          );


                        
        var view = new google.visualization.DataView(data);
        view.setColumns([0,1]);


        //flotTextData();
        //$('#run').bind('click', flotTextData);

        // labels = ["VIVIENDA Y ENTORNO", "SALUD Y MEDIO AMBIENTE", "CONDICIONES SOCIOCULTURALES", "AMBIENTE DE NEGOCIOS", "CONDICIÓN LABORAL", "CONECTIVIDAD Y MOVILIDAD"];

        dataFull1 = //google.visualization.arrayToDataTable(array);
        new google.visualization.arrayToDataTable([
         ['Employee Name', 'Salary'],
         ['Vivienda y Entorno', {v:22500, f:'22,500'}], // Format as "22,500".
         ['Salud y Medio Ambiente', 35000],
         ['Condiciones Socioculturales', 44000],
         ['Ambiente de Negocios', 27000],
         ['Condicion Laboral', 92000],
         ['Conectividad y Movilidad', 18500]
        ],
        false); // 'false' means that the first row contains labels, not data.



        dataFull2 = //google.visualization.arrayToDataTable(array);
          new google.visualization.arrayToDataTable([
         ['Employee Name', 'Salary'],
         ['Vivienda y Entorno', {v:2250, f:'22,500'}], // Format as "22,500".
         ['Salud y Medio Ambiente', 3500],
         ['Condiciones Socioculturales', 4400],
         ['Ambiente de Negocios', 2700],
         ['Condición Laboral', 9200],
         ['Conectividad y Movilidad', 1850]
        ],
        false); // 'false' means that the first row contains labels, not data.

        var dataFull = [dataFull1, dataFull2];

        //data.sort([{column: 1}, {column: 0}]);
        //data.sort([{column: 1}, {column: 0}]);
        data.sort([{column: 1, desc: true}]);




        // Create a dashboard.
        dashboard = new google.visualization.Dashboard( document.getElementById('dashboard_div')) ;

        // Create a range slider, passing some options
        var donutRangeSlider = new google.visualization.ControlWrapper({
          'controlType': 'NumberRangeFilter',
          'containerId': 'filter_div',
          'options': {
            'filterColumnLabel': 'Población',
            'minValue': '0',
          }
        });

        // Create a pie chart, passing some options
        barChart = new google.visualization.ChartWrapper({
          'chartType': 'BarChart',
          'containerId': 'chartRanking',
          'options': {
            'width': 600,
            'height': MAXHeight,
            'pieSliceText': 'value',
            'legend': 'right',
            title: 'Ranking ICVU 2017 para '+ theTitle,
            'hAxis': {'minValue': '0'},
            'animation':{
              'duration': '1000',
              'easing': 'out',
            },
            'tooltip': {'isHtml': true}
          }
        });

        var mi_aux = 0;
        var selection;
        // Instantiate and draw our chart, passing in some options.
        //chartTool = new google.visualization.ColumnChart(document.getElementById('chartDetail'));
        chartTool = new google.visualization.BarChart(document.getElementById('chartDetail'));

        google.visualization.events.addListener(barChart, 'select', function () {
          console.log("Click: " + barChart.getChart().getSelection());
           selection = barChart.getChart().getSelection();
          //var selectedRow = selection[i].row;
          /*
          var selectedRow = selection[i].row;
          var dataTableRow = barChart.getView().rows[selectedRow];
          var values = '';
          for (var col = 0; col < data.getNumberOfColumns(); col++) {
            if (values !== '') {
              values += ' -- ';
            }
            values += data.getValue(dataTableRow, col);
          }*/
          message ='';
          for (var i = 0; i < selection.length; i++) {
            var item = selection[i];
            if (item.row != null && item.column != null) {
              message += '{row:' + item.row + ',column:' + item.column + '}';
            } else if (item.row != null) {
              message += '{row:' + item.row + '}';
            } else if (item.column != null) {
              message += '{column:' + item.column + '}';
            }
          }
          if (message == '') {
            message = 'nothing';
            
          }
          if (item != null && item.row != null ){
                    var id = barChart.getDataTable().getValue(item.row,0);
                    var originalRow = data.getFilteredRows([{column: 0, value: id }]);
                    originalRow = parseInt(originalRow);
                    var originalData = data.getFormattedValue(originalRow, 1);
          
                    console.log("originalIndexRow: " + originalRow);
                    console.log("originalDataRow: " + originalData);
                    console.log("*** values: " + message);
          
                     selection = barChart.getChart().getSelection();
          
                    var selectedItem = barChart.getChart().getSelection()[0];
                    if (selectedItem) {
                      var value = data.getValue(selectedItem.row, selectedItem.column);
                      //console.log('- The user selected ' + value + ', '+barChart.getChart().getSelection()[0][1] );
          
          
                      var id = barChart.getDataTable().getValue(item.row,0);
                      var originalRow = data.getFilteredRows([{column: 0, value: id }]);
                      originalRow = parseInt(originalRow);
                      var originalData = data.getFormattedValue(originalRow, 1);
                      var originalNameData = data.getFormattedValue(originalRow, 0);
                      
          
                      var optionsTool = {
                        width: 600,
                        height: 600,
                        title: 'Detalle para ' + originalNameData,
                        colors: ['#e0440e', '#e6693e', '#ec8f6e', '#f3b49f', '#f6c7b6'],
          
                        animation:{
                          duration: 1000,
                          easing: 'out',
                        },
          
                        hAxis: {'minValue': '0'},
                       chartArea: {
                        'width': '40%', 'height': '80%',
                        left:200,
                        right:40, // !!! works !!!
                        //bottom:20,  // !!! works !!!
                        //top:20
                      },
                       legend: {'position': 'bottom'}
                      };
          
                      var message = '';
          
                      for (var i = 0; i < selection.length; i++) {
                        var item = selection[i];
                        if (item.row != null && item.column != null) {
                          message += '{row:' + item.row + ',column:' + item.column + '}'  + ' ===> (' + data.getValue(item.row, 0)+': '+ data.getValue(item.row, 1)+')';
                        } else if (item.row != null) {
                          message += '{row:' + item.row + '}';
                        } else if (item.column != null) {
                          message += '{column:' + item.column + '}';
                        }
                      }
                      if (message == '') {
                        message = 'nothing';
                      }
                      console.log('You selected ' + message);
          
          
                      //dashboard.draw(data, options);
          
                      // chartTool.draw(dataFull[(mi_aux++)%2], optionsTool);
                      //chartTool.draw(selection, optionsTool);
                      s = data.getFilteredRows([{column: 0, value: id}]) ;
                      console.log("data.getFilteredRows([{column: 0, value: id }])=== "+ s);
                      
                      var view = new google.visualization.DataView(data);
                      indexPopulation = 1;
                      view.setRows(data.getFilteredRows([
                        {column: 0, value: id}
                      ]));
                      N = view.getNumberOfColumns();
                      //if(N > 2)
                      {
                        view.setColumns([0,7, 8,9,10,11,12,13]); // AQUIIII

                        //view.hideColumns([indexPopulation]);
                      }
                      chartTool.draw(view, optionsTool);          
          
                    }}


        }); // FIN google.visualization.events.addListener(barChart, 'select', function () {

        // Establish dependencies, declaring that 'filter' drives 'barChart',
        // so that the pie chart will only display entries that are let through
        // given the chosen slider range.
        dashboard.bind(donutRangeSlider, barChart);

        // Draw the dashboard.
        //dashboard.draw(data);
        //dashboard.draw(data, {allowHtml: true, showRowNumber: true, width: '100%', height: '100%'});

        //dashboard.draw(data, options);
        //dashboard.draw(excludeEmptyRows(data), options);
        barChart.setOption('title', 'Ranking ICVU 2017 para '+ theTitle );
        dashboard.draw((view), options);

       }); // FIN GET
      } // FIN drawDashboard
/// Dashboard <=


      function updateChart(){
        /*
        FILTROS:
        =========
        - población
        - norte a sur
        - costeras o mediterráneas
        - metropolitanas o no
        - porcentaje
        - per cápita

          ORDEN:
        =========
        - de mayor a menor indicador por dimensión,
        - de mayor a menor indicador por dimensión ICVU como índice sintético, ó
        - geográficamente (norte a sur).
        */
        order1 =  parseInt($("#order1 option:selected").val());
        order2 =  parseInt($("#order2 option:selected").val());

        data.sort([{column: order1, desc: (order2%2 == 0)}]);
        theTitle = $("#order1 option:selected").text();
        barChart.setOption('title', 'Ranking ICVU 2017 para '+ theTitle );
        dashboard.draw(data, options);

      } // FIN updateChart

      var order1 = 1;
      $( document ).ready(function() {
        theTitle = $("#order1 option:selected").text();
          order1 =  parseInt($("#order1 option:selected").val());
          order2 =  parseInt($("#order2 option:selected").val());
          //console.log( "text_commune! " + order1 );

          $('#order1').change(function() {
              updateChart();
          });

          $('#order2').change(function() {
              updateChart();
          });

      }); // FIN $( document ).ready(
  </script>

  </head>
  <body>





<!-- Dashboard > -->

    <!--Div that will hold the dashboard-->
    <div id="dashboard_div">
<!--
LINK PARA AGREGAR BOOLEAN
https://stackoverflow.com/questions/41944874/color-google-virtualization-boolean-column
-->
<!--
      <textarea id="textInput" style="height:50px;width: 800px">
Comuna,Población,Distribución Geográfica,Localización Geográfica,Comuna Metropolitana ,Dependencia FCM (%),Gasto total municipal por cada habitante de la comuna  M$ / Habitante (promedio 2013-2015),ICVU2017,CL,AN,CS,CM,SM,VE,RANGO
Alto Hospicio,124872,Norte,Costa,si,55.60,109.50,33.40,47.40,6.00,14.70,46.10,41.50,31.50,INFERIOR
Angol,55845,Sur,Interior,no,69.70,170.20,47.70,53.90,22.70,45.20,40.80,55.40,58.20,SUPERIOR
Antofagasta,389812,Norte,Costa,si,14.30,187.30,40.40,51.30,32.60,30.60,56.90,38.10,28.90,PROMEDIO
Arica,243701,Norte,Costa,no,46.20,113.30,38.00,48.50,16.10,23.60,51.40,40.00,37.40,PROMEDIO
</textarea>
      <input id="run" type="button"  value="Run" />
      <hr />
-->


      <div id="tabla" style="
    
"></div>

      <h3>Orden:</h3><br>


      <label for="order1">Orden por:</label>
      <select name="order1" id="order1">
        <option value=0>Comuna</option>
        <option value=1 selected="true">Población</option>
        <option value=2>D1</option>
        <option value=3>D2</option>
      </select><br>
      
      <br>
      <label for="order2">en forma:</label>
      <select name="order2" id="order2">
        <option value=1>Ascendente (A..Z)</option>
        <option value=2>Descendente (Z..A)</option>
      </select>

      <!--Divs that will hold each control and chart-->
      <div id="filter_div"></div>
      <div class="row">


          <div class="col-md-6">
            <div id="chartRanking"></div>
          </div>
          <div class="col-md-6">

            <div id="chartDetail"></div>
          </div>
      </div>
    </div>

    <!-- Dashboard < -->
    <div id="dual_x_div"></div>
    <canvas class="" id="canvas"></canvas>
    <button id="button1">
      EXPORTAR Ranking
    </button>
    <button id="button2">
      EXPORTAR Detalle
    </button>

  </body>
</html>
